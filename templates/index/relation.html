{% extends "index/navigate.html" %} {% block mainbody %}
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <meta charset="utf-8" />
<!--    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>                         -->
    <script src="/static/js/echarts.js"></script>
</head>
<title>关系</title>
<div class="container">
    <div class="row">
    <!--head start-->
    <div class="col-md-12">
        <h3 class="page-header"><i class="fa fa-link" aria-hidden="true"></i> 关系查询 </h3>
            <ol class="breadcrumb">
                <li><i class="fa fa-home"></i><a href="/admin/welcome">主页</a></li>
                <li><i class="fa fa-link" aria-hidden="true"></i>关系查询</li>
            </ol>
    </div>
            <div class = "col-md-12">
        <div class="panel panel-default">
             <header class="panel-heading">
            标签列表 :
        </header>
            <div class = "panel-body" >
                <div class="table-responsive" style="height:300px;overflow-y: scroll;">
                               <table class="table table-striped table-bordered ">
                                 <thead>
                                   <tr>
                                     <th>关系标签</th>
                                     <th></th>
                                     <th></th>
                                       <th></th>
                                     <th></th>
                                        <th></th>
                                     <th></th>
                                   </tr>
                                 </thead>
                                 <tbody>
                                 {% set cnt = [0] %}
                                 {% for label_num in home_dict["relationship_type"] %}
                                      {% if cnt.append(cnt.pop() + 1) %}{% endif %}
                                     {% if loop.index%6==0 %}
                                      {% for i in [1,2,3,4,5,6,7,8,9,10,11,12,13,14] %}
                                        {% if cnt[0]/6==i %}
                                     <tr>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-6] }}/1/0">{{ home_dict["relationship_type"][i*6-6] }}</a></td>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-5] }}/1/0">{{ home_dict["relationship_type"][i*6-5] }}</a></td>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-4] }}/1/0">{{ home_dict["relationship_type"][i*6-4] }}</a></td>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-3] }}/1/0">{{ home_dict["relationship_type"][i*6-3] }}</a></td>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-2] }}/1/0">{{ home_dict["relationship_type"][i*6-2] }}</a></td>
                                         <td><a href="/search_relation/{{ home_dict["relationship_type"][i*6-1] }}/1/0">{{ home_dict["relationship_type"][i*6-1] }}</a></td>
                                     </tr>
                                          {% endif %}
                                          {% endfor %}
                                     {% endif %}
                                     {% if loop.last %}
                                     {% for j in [0,1,2,3,4,5] %}
                                         {% if j<cnt[0]%6 %}
                                             <td><a href="/search_relation/{{ home_dict["relationship_type"][cnt[0]-j-1]}}/1/0">{{ home_dict["relationship_type"][cnt[0]-j-1]  }}</a></td>
                                         {% endif %}
                                         {% endfor %}
                                     {% endif %}
                                 {% endfor %}
                                 </tbody>
                               </table>
                              </div>
            </div>
        </div>
    </div>
    {% if not relation_tag=='None' %}
        <div class = "col-md-12">
    <div class="panel panel-default">
    <header class="panel-heading">
        关系列表 :
    </header>
	        <div class = "panel-body">
                   <div class="table-responsive" style="height:500px;overflow-y: scroll;">
                   <table class="table table-striped table-bordered">
                     <thead>
                       <tr>
                           <th>序号</th>
                         <th>实体一</th>
                         <th>关系</th>
                         <th>实体二</th>
                       </tr>
                     </thead>
                     <tbody>
                     {% for tuple in tuplelist1 %}
                       <tr>
                       <td>{{ loop.index }}</td>
                                   <td><b>{{ tuple[0][0]}}</b>
                                     {% for key in tuple[0][1] %}
                                         <br><b style="color: red">{{ key }}</b>:{{ tuple[0][1][key]}}
                                         {% endfor %}
                                 </td>
                                 <td>{{tuple[1] }}</td>
                                   <td><b>{{ tuple[2][0]}}</b>
                                     {% for key in tuple[2][1] %}
                                         <br><b  style="color: red">{{ key }}</b>:{{ tuple[2][1][key]}}
                                         {% endfor %}
                                 </td>
                       </tr>
                     {% endfor %}
                     </tbody>
                   </table>
                  </div>
                           <ul class="pager">
                               <li><a href="/search_entity/{{relation_tag}}/1/0">第一页</a></li>
	<li><a href="/search_relation/{{relation_tag}}/{{ pagecounter }}/2">前一页</a></li>
	<li><a href="/search_relation/{{relation_tag}}/{{ pagecounter }}/1">后一页</a></li>
        <li><p >当前第{{ pagecounter }}页</p></li>
</ul>
	        </div>
    </div>
</div>
{% endif %}
    <div class = "col-md-12">
    	<div class = "panel panel-default">
			<header class="panel-heading">
            查询条件：
       		</header>
       		<div class = "panel-body">
				<form method="post" action="/search_relation/None/0/0">
                    {{ form.csrf_token }}
					<div class="input-group">
						{{ form.entity1(class="form-control", placeholder="标签：实体名", style="width:200px;margin:0px 20px;") }}
						{{ form.relation(class="form-control", placeholder="路径长度,最大为8", style="width:200px;margin:0px 20px;") }}
						{{ form.entity2(class="form-control", placeholder="标签：实体名", style="width:200px;margin:0px 20px;") }}
						{{ form.submit(class="btn btn-primary", style="background-color:#4592fe;margin:0px 20px;") }}
					</div>
                </form>
			</div>
		</div>
	</div>

	{% if not tuplelist[0]  %}
	<div class = "col-md-12">
		<div class = "panel panel-default">
			<header class = "panel-heading">
				查询结果：
			</header>
			<div class = "panel-body">
				<div style="padding: 2%">
					<h2>不存在匹配关系或者输入有误</h2>
				</div>
			</div>
		</div>
	</div>
	{% endif %}

  {% if tuplelist[0]  %}
    {% if not tuplelist[0]=='padding'  %}

    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div class = "col-md-12">
        <div class="panel panel-default ">
	        <header class="panel-heading">
	            关系图 :
	        </header>
            <div class = "panel-body ">
                <div id="graph" style="width: 100%;height:900px;"></div>
            </div>
        </div>
    </div>
    <!-- Footable -->
    <div class = "col-md-12">
	    <div class="panel panel-default">
	    	<header class="panel-heading">
	       	 关系列表 :
	   		</header>
	        <div class = "panel-body">
                   <div class="table-responsive" style="height:700px;overflow-y: scroll;">
                   <table class="table table-striped table-bordered">
                     <thead>
                       <tr>
                           <th>序号</th>
                         <th>实体一</th>
                         <th>关系</th>
                         <th>实体二</th>
                       </tr>
                     </thead>
                     <tbody>
                     {% for tuple in tuplelist %}
                       <tr>
                       <td>{{ loop.index }}</td>
                                   <td><b>{{ tuple[0][0]}}</b>
                                     {% for key in tuple[0][1] %}
                                         <br><b>{{ key }}</b>:{{ tuple[0][1][key]}}
                                         {% endfor %}
                                 </td>
                                 <td>{{tuple[1] }}</td>
                                   <td><b>{{ tuple[2][0]}}</b>
                                     {% for key in tuple[2][1] %}
                                         <br><b  style="color: red">{{ key }}</b>:{{ tuple[2][1][key]}}
                                         {% endfor %}
                                 </td>
                       </tr>
                     {% endfor %}
                     </tbody>
                   </table>
                  </div>
	        </div>
	    </div>
	</div>
    {% endif %}
{% endif %}
</div>
</div>
{% if tuplelist[0]  %}
    {% if not tuplelist[0]=='padding'  %}
        <script type="text/javascript">
                // 基于查询结果：初始化Data和Links列表，用于Echarts可视化输出
                var tuplelist = {{ tuplelist|safe }} ;
                var data = [] ;
                var links = [] ;
                var maxDisPlayNode =70*{{ path_length|safe }};
                id=0
                {#if(maxDisPlayNode<=tuplelist.length)#}
                for( var i = 0 ;i < Math.min(maxDisPlayNode,tuplelist.length) ; i++ ){
                    var flag = 1 ;
                    relation = {};
                    relation['value'] = [i+1,tuplelist[i][1]];
                    relation['category'] = 0 ;
                    node = {} ;
                    node['draggable'] = true ;   //是否允许拖拽

                    node['category'] = 2 ;
                    node['name']=tuplelist[i][0][0]
                   node['value'] = tuplelist[i][0][1]['name'] ;
                if('{{ entity2list[0][1] }}'==node['value'] ) {
                        if ('{{ entity2list[0][0] }}'== node['name']) {
                            node['category'] = 0;
                        }
                    }
                    if('{{ entity2list[1][1] }}'==node['value'] ) {
                        if ('{{ entity2list[1][0] }}'== node['name']) {
                            node['category'] = 1;
                        }
                    }
                    for(var j = 0 ; j<data.length ;j++){
                        if(data[j]['value'] ===node['value'] ){
                            if(data[j]['name'] === node['name']) {
                                relation['source'] = data[j]['id'];
                                flag = 0;
                                break;
                            }
                        }
                    }
                     if(flag == 1){
                         id=i+50;
                         node['id']=id.toString();
                         relation['source'] = node['id'] ;
                         data.push(node) ;
                    }
                    flag = 1
                    node = {} ;
                    node['category'] = 2 ;
                    node['draggable'] = true ;   //是否允许拖拽
                    node['name']=tuplelist[i][2][0]
                   node['value'] = tuplelist[i][2][1]['name'] ;
                if('{{ entity2list[0][1] }}'==node['value'] ) {
                        if ('{{ entity2list[0][0] }}'== node['name']) {
                            node['category'] = 0;
                        }
                    }
                if('{{ entity2list[1][1] }}'==node['value'] ) {
                        if ('{{ entity2list[1][0] }}'== node['name']) {
                            node['category'] = 1;
                        }
                    }
                    for(var j = 0 ; j<data.length ;j++){
                        if(data[j]['value'] ==node['value']){
                            if(data[j]['name'] == node['name']) {
                                relation['target'] = data[j]['id'];
                                flag = 0;
                                break;
                            }
                        }
                    }
                     if(flag == 1){
                         id=1200+i;
                         node['id']=id.toString();
                         relation['target'] = node['id'] ;
                        data.push(node) ;
                    }
                        relation['symbolSize'] = 10
                        links.push(relation) ;
                }

                // 基于准备好的数据：Data和Links，设置Echarts参数
                var myChart = echarts.init(document.getElementById('graph'));
                option = {
                    title: {
                        text: ''
                    },                //标题
                    tooltip: {formatter: "{c}",},                           //提示框配置
                    animationDurationUpdate: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    legend: {
                        x: "left",
                        show: true
                    },
                    series: [
                        {
                            type: 'graph',                //系列：
                            layout: 'force',
                            symbolSize: 50,
                            focusNodeAdjacency: true,
                            roam: true,
                            edgeSymbol: ['none', 'arrow'],
                            categories: [{
                                name: '首节点',
                                itemStyle: {
                                    normal: {
                                        color: "#009800",
                                    }
                                }
                            }, {
                                name: '尾节点',
                                itemStyle: {
                                    normal: {
                                        color: "#ffe645",
                                    }
                                }
                            }, {
                                name: '中间节点',
                                itemStyle: {
                                    normal: {
                                        show:false,
                                        color: "#0a9bec",
                                    }
                                }
                            }],
                            label: {
                                normal: {
                                    show:true,
                                    formatter: "{b}",
                                    textStyle: {
                                        color:"black",
                                        fontSize: 12,
                                    }
                                }
                            },               //节点标签样式
                            force: {
                                     repulsion: [400,2000],  //节点之间的斥力因子。支持数组表达斥力范围，值越大斥力越大。
                                     edgeLength:[150,180],   //边的两个节点之间的距离，值越小则长度越长，这个距离也会受 repulsion影响。
                                     gravity: 1.12,  //节点受到的向中心的引力因子。该值越大节点越往中心点靠拢。
                                     layoutAnimation : false  //初始化时转动动画
                            },
                            edgeSymbolSize: [50, 200],
                            edgeLabel: {
                                normal: {
                                    show: false,
                                    textStyle: {
                                        color:"#ec0a0a",
                                        fontSize: 11
                                    },
                                     formatter: function(params) {
                                        return params.value[1]  }
                                }
                            },           //边标签样式
                            data: data,                 //节点
                            links: links,               //节点间的关系
                            lineStyle: {
                                normal: {
                                    opacity: 0.9,
                                    width: 1.3,
                                    curveness: 0.07,
                                    color:"#262626"
                                }
                            }            // 连接线的风格
                        }
                    ]
                };
                myChart.setOption(option);
        </script>
    {% endif %}
{% endif %}
{% endblock %}
